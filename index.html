<!DOCTYPE html>
<html lang="sr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Block Puzzle 8√ó8 ‚Äî Stable One-File</title>
<style>
:root{
  --bg:#0e0f12; --text:#e8ecf1; --muted:#a6afc3; --accent:#ffd166;
  --panel: rgba(18,22,30,.35);
  --grid-border: rgba(255,255,255,.10);
}
.light{
  --bg:#f6f8fb; --text:#0e1014; --muted:#4c5672; --accent:#e5b54a;
  --panel: rgba(255,255,255,.45);
  --grid-border: rgba(0,0,0,.12);
}
*{ box-sizing:border-box; }
html,body{
  height:100%; margin:0; background:var(--bg); color:var(--text);
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif;
  overflow:hidden;
  -webkit-tap-highlight-color: transparent;
}
.wrap{ display:flex; flex-direction:column; height:100%; max-width:720px; margin:0 auto; }
header{ padding:12px 16px; display:flex; align-items:center; justify-content:space-between; gap:8px; }
.brand{ font-weight:800; letter-spacing:.3px; opacity:.92 }
.hud{ display:flex; gap:12px; align-items:center; }
.pill{ background:#16192266; padding:6px 10px; border-radius:12px; font-weight:700; opacity:.95 }
.toolbar{ display:flex; gap:8px; align-items:center; }

/* Dugmad */
.btn, .icon-btn, button{
  background:transparent; color:var(--text); border-radius:14px; font-weight:700; cursor:pointer;
  outline:none; user-select:none; -webkit-user-select:none; -ms-user-select:none;
  -webkit-tap-highlight-color: transparent;
}
.btn{ border:1px solid #2b2f3a; padding:8px 12px; }
.icon-btn{
  border:none; background:#00000033; backdrop-filter: blur(6px);
  padding:12px 14px; border-radius:16px; font-weight:800;
}
button:focus, .btn:focus, .icon-btn:focus{ outline:none; }
*:focus{ outline:none; }

/* Board */
.board-area{ flex:1; display:flex; align-items:center; justify-content:center; padding:8px 16px 0; position:relative; }
canvas{ touch-action:none; border-radius:18px; display:block; }

.tray{ display:grid; grid-template-columns: repeat(3, 1fr); gap:10px; padding:12px 16px 18px; }
.slot{ background:#141720; border:1px dashed #2b2f3a; border-radius:16px; min-height:96px;
  display:flex; align-items:center; justify-content:center; position:relative; transition:border-color .18s, box-shadow .18s, opacity .18s; }
.slot.used{ opacity:.3 }
.slot.good{ border-color:#57c857; box-shadow:0 0 0 2px color-mix(in oklab, #57c857 40%, transparent); }
.slot.bad { border-color:#e06b6b; box-shadow:0 0 0 2px color-mix(in oklab, #e06b6b 40%, transparent); }

.footer{ text-align:center; opacity:.6; font-size:12px; padding-bottom:10px }

/* OVERLAYS */
.overlay{ position:fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index:20; }
.overlay .backdrop{ position:absolute; inset:0; background:rgba(0,0,0,.55); -webkit-backdrop-filter: blur(4px); backdrop-filter: blur(4px); }
.overlay .panel{ position:relative; background:var(--panel); border:1px solid var(--grid-border); border-radius:16px; padding:16px; width:min(92vw,460px); box-shadow:0 12px 40px rgba(0,0,0,.45) }
.overlay .row{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:8px 0; }

/* START SCREEN */
.start{ position:fixed; inset:0; display:flex; align-items:center; justify-content:center; overflow:hidden; }
#bg{
  position:absolute; inset:0; width:100%; height:100%;
  pointer-events:none; /* ‚úÖ da aurora ne blokira klik na dugmad */
}
.ss-inner{ position:relative; z-index:1; display:flex; flex-direction:column; align-items:center; gap:16px; padding:16px; }
.ss-inner h1{ margin:0; font-size:32px; letter-spacing:.6px; text-shadow:0 10px 30px rgba(0,0,0,.35); color:#f6e3a1 }

/* Ikonice gore desno, vertikalno */
.top-icons{
  position:absolute; top:14px; right:14px;
  display:flex; flex-direction:column; align-items:flex-end; gap:10px;
}
.top-icons .icon-btn{ font-size:22px; }

/* dugmad za modove */
.modes{ display:flex; flex-direction:column; gap:10px; }
.btn.gold{
  padding:12px 20px; border-radius:14px; font-weight:800; color:#e8ecf1; background:#0b0d12;
  border:1px solid #e4bf66; box-shadow: inset 0 0 0 1px #3a2a0b, 0 8px 22px rgba(0,0,0,.35); cursor:pointer;
}

/* sakriven best na startu */
.bestBoard{ display:none; }

/* settings modal basic */
#settingsModal{ display:none; }
</style>
</head>
<body>
  <!-- START -->
  <div id="startScreen" class="start">
    <canvas id="bg"></canvas>
    <div class="ss-inner">
      <div class="top-icons">
        <button id="settingsBtn" class="icon-btn" title="Pode≈°avanja">‚öôÔ∏è</button>
        <button id="achBtn" class="icon-btn" title="Dostignuƒáa">üèÜ</button>
      </div>
      <h1>BLOCK ‚Ä¢ 8√ó8</h1>
      <div class="modes">
        <button id="startClassic" class="btn gold">‚ñ∂ Classic</button>
        <button id="startObstacles" class="btn gold">üß± Obstacles</button>
        <button id="startZen" class="btn gold">üßò Zen</button>
      </div>
    </div>
  </div>

  <!-- APP -->
  <div class="wrap" id="app" style="display:none">
    <header>
      <div class="brand">BLOCK ‚Ä¢ 8√ó8</div>
      <div class="hud">
        <div class="pill">Score: <span id="score">0</span></div>
        <div class="pill">Best: <span id="best">0</span> üëë</div>
      </div>
      <div class="toolbar">
        <button id="backBtn" class="icon-btn" title="Meni">üè†</button>
        <button id="reset" class="btn" title="Nova igra">Reset</button>
      </div>
    </header>
    <div class="board-area">
      <canvas id="game" width="360" height="360" aria-label="8√ó8 tabla"></canvas>
      <canvas id="fx" width="360" height="360" style="position:absolute; inset:0; pointer-events:none"></canvas>
    </div>
    <div class="tray" id="tray"></div>
    <div class="footer">Stable ‚Ä¢ Aurora ‚Ä¢ 8√ó8 ‚Ä¢ Drag above finger</div>
  </div>

  <!-- SETTINGS -->
  <div id="settingsModal" class="overlay" style="display:none">
    <div class="backdrop"></div>
    <div class="panel">
      <h3>Pode≈°avanja</h3>
      <div class="row"><span>Tema</span><button id="setTheme" class="btn">Prebaci temu</button></div>
      <div class="row"><span>Zvuk</span><button id="setSound" class="btn">üîà On</button></div>
      <div class="row"><span>Resetuj Best</span><button id="resetBest" class="btn">Obri≈°i</button></div>
      <div class="row"><span>Testovi</span><button id="runTests" class="btn">Pokreni testove</button></div>
      <div style="text-align:right; margin-top:8px"><button id="closeSettings" class="btn">Zatvori</button></div>
    </div>
  </div>

  <!-- GAME OVER -->
  <div id="gameOver" class="overlay" style="display:none">
    <div class="backdrop"></div>
    <div class="panel">
      <h2>Kraj igre</h2>
      <div id="goStats" style="margin:6px 0 12px 0">Score: 0 ‚Ä¢ Best: 0</div>
      <div style="display:flex; gap:8px; justify-content:center">
        <button id="playAgain" class="btn">Igraj ponovo</button>
        <button id="goMenu" class="btn">Meni</button>
      </div>
    </div>
  </div>

<script>
(function(){
  'use strict';

  // DOM
  const canvas = document.getElementById('game');
  const ctx    = canvas.getContext('2d', {alpha:true});
  const fxCnv  = document.getElementById('fx');
  const fctx   = fxCnv.getContext('2d', {alpha:true});
  const app    = document.getElementById('app');
  const start  = document.getElementById('startScreen');
  const bg     = document.getElementById('bg');
  const trayEl = document.getElementById('tray');
  const scoreEl= document.getElementById('score');
  const bestEl = document.getElementById('best');
  const resetBtn = document.getElementById('reset');
  const backBtn  = document.getElementById('backBtn');
  const settingsBtn   = document.getElementById('settingsBtn');
  const settingsModal = document.getElementById('settingsModal');
  const setTheme      = document.getElementById('setTheme');
  const setSound      = document.getElementById('setSound');
  const resetBest     = document.getElementById('resetBest');
  const closeSettings = document.getElementById('closeSettings');
  const runTestsBtn   = document.getElementById('runTests');
  const achBtn   = document.getElementById('achBtn');
  const gameOver = document.getElementById('gameOver');
  const goStats  = document.getElementById('goStats');
  const playAgain= document.getElementById('playAgain');
  const goMenu   = document.getElementById('goMenu');
  const startClassic   = document.getElementById('startClassic');
  const startObstacles = document.getElementById('startObstacles');
  const startZen       = document.getElementById('startZen');

  ctx.imageSmoothingEnabled=false; fctx.imageSmoothingEnabled=false;

  const DPR=Math.min(devicePixelRatio||1,2), BOARD=8, COLORS=['#FF6B6B','#F94144','#F3722C','#F8961E','#F9844A','#FFD166','#F6BD60','#7BD389','#70C1B3','#4D9DE0','#5B8CFF','#C97FFF','#E56B6F','#FF9F1C'];
  const OBSTACLE_COLOR='#3a404d';
  const LS=(k,v)=> (v===undefined? localStorage.getItem(k) : localStorage.setItem(k,v));
  const settings = { theme: LS('bp8.theme')||'dark', sound: LS('bp8.sound')!==null ? LS('bp8.sound')==='1' : true };
  applyTheme(settings.theme); updateSoundLabel();
  const bestByMode = loadBest() || {classic:0, obstacles:0, zen:0};
  const state = { grid:createGrid(BOARD), cell:36, score:0, mode:'classic', best:bestByMode, hand:[], dragging:null };

  // Utils
  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
  function createGrid(n){ return Array.from({length:n},()=>Array(n).fill(0)); }
  function hexToRgb(hex){ const m=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex.trim()); if(!m) return {r:255,g:200,b:150}; return {r:parseInt(m[1],16), g:parseInt(m[2],16), b:parseInt(m[3],16)}; }
  function adjustColor(hex,amt){ const {r,g,b}=hexToRgb(hex); const nr=clamp(Math.round(r+(255-r)*amt),0,255); const ng=clamp(Math.round(g+(255-g)*amt),0,255); const nb=clamp(Math.round(b+(255-b)*amt),0,255); return `rgb(${nr},${ng},${nb})`; }
  function darkenColor(hex,amt){ const {r,g,b}=hexToRgb(hex); const nr=clamp(Math.round(r*(1-amt)),0,255); const ng=clamp(Math.round(g*(1-amt)),0,255); const nb=clamp(Math.round(b*(1-amt)),0,255); return `rgb(${nr},${ng},${nb})`; }
  function rr(c,x,y,w,h,r){ r=Math.min(r,w*.5,h*.5); c.beginPath(); c.moveTo(x+r,y); c.arcTo(x+w,y,x+w,y+h,r); c.arcTo(x+w,y+h,x,y+h,r); c.arcTo(x,y+h,x,y,r); c.arcTo(x,y,x+w,y,r); c.closePath(); }
  function getCss(v){ return getComputedStyle(document.body).getPropertyValue(v); }

  // Aurora
  function drawAurora(c,w,h){
    c.save();
    const bg=c.createLinearGradient(0,0,w,h);
    bg.addColorStop(0,'rgba(160,210,255,0.33)'); bg.addColorStop(0.55,'rgba(220,255,230,0.31)'); bg.addColorStop(1,'rgba(255,210,160,0.29)');
    c.fillStyle=bg; c.fillRect(0,0,w,h);
    c.globalCompositeOperation='screen';
    const g1=c.createRadialGradient(w*.25,h*.35,10,w*.25,h*.35,Math.max(w,h)*.8);
    g1.addColorStop(0,'rgba(120,200,255,0.34)'); g1.addColorStop(1,'rgba(120,200,255,0)'); c.fillStyle=g1; c.fillRect(0,0,w,h);
    const g2=c.createRadialGradient(w*.75,h*.70,10,w*.75,h*.70,Math.max(w,h)*.9);
    g2.addColorStop(0,'rgba(255,180,150,0.30)'); g2.addColorStop(1,'rgba(255,180,150,0)'); c.fillStyle=g2; c.fillRect(0,0,w,h);
    c.restore();
  }
  function drawStartAurora(){
    const b=bg.getContext('2d'); b.setTransform(1,0,0,1,0,0); b.scale(DPR,DPR);
    b.clearRect(0,0,bg.width,bg.height); drawAurora(b, innerWidth, innerHeight);
    requestAnimationFrame(drawStartAurora);
  }

  // Shapes
  const SHAPES=(function(){
    const raw=[
      [[0,0]],
      [[0,0],[1,0]], [[0,0],[1,0],[2,0]], [[0,0],[1,0],[2,0],[3,0]], [[0,0],[1,0],[2,0],[3,0],[4,0]],
      [[0,0],[0,1]], [[0,0],[0,1],[0,2]], [[0,0],[0,1],[0,2],[0,3]], [[0,0],[0,1],[0,2],[0,3],[0,4]],
      [[0,0],[1,0],[0,1],[1,1]],
      [[0,0],[1,0],[2,0],[0,1]],
      [[0,0],[1,0],[2,0],[1,1]],
      [[0,0],[1,0],[0,1],[0,2]],
      [[0,0],[1,0],[1,1],[1,2]],
    ];
    return raw.map(shape=>{
      const minx=Math.min(...shape.map(b=>b[0])), miny=Math.min(...shape.map(b=>b[1]));
      const blocks=shape.map(([x,y])=>[x-minx,y-miny]);
      const w=Math.max(...blocks.map(b=>b[0]))+1, h=Math.max(...blocks.map(b=>b[1]))+1;
      return {blocks,w,h};
    });
  })();
  function rndColor(){ return COLORS[Math.floor(Math.random()*COLORS.length)]; }
  function newPiece(){ const s=SHAPES[Math.floor(Math.random()*SHAPES.length)];
    return { blocks:s.blocks.map(b=>[b[0],b[1]]), w:s.w, h:s.h, color:rndColor(), used:false, id:Math.random().toString(36).slice(2) };
  }

  // Rules
  function canPlace(piece,gx,gy){
    for(const [dx,dy] of piece.blocks){
      const x=gx+dx, y=gy+dy;
      if(x<0||y<0||x>=BOARD||y>=BOARD) return false;
      if(state.grid[y][x]!==0) return false;
    } return true;
  }
  function canFitAnywhere(piece){
    for(let y=0;y<=BOARD-piece.h;y++){ for(let x=0;x<=BOARD-piece.w;x++){ if(canPlace(piece,x,y)) return true; } }
    return false;
  }
  function anyFits(){ return state.hand.some(p=>!p.used && canFitAnywhere(p)); }

  // Drawing
  function drawMatBlock(c,x,y,s,base,{alpha=1,placed=false}={}){
    c.save(); c.globalAlpha=alpha;
    rr(c,x+1,y+1,s-2,s-2,Math.max(6,s*.22));
    const body=c.createLinearGradient(x,y,x,y+s);
    body.addColorStop(0,adjustColor(base,.12)); body.addColorStop(1,darkenColor(base,.16));
    c.fillStyle=body; c.fill();
    const inner=c.createLinearGradient(x,y,x+s,y+s);
    inner.addColorStop(0,'rgba(0,0,0,.10)'); inner.addColorStop(0.5,'rgba(0,0,0,0)');
    rr(c,x+1,y+1,s-2,s-2,Math.max(6,s*.22)); c.save(); c.globalCompositeOperation='multiply'; c.fillStyle=inner; c.fill(); c.restore();
    const light=c.createLinearGradient(x,y,x+s,y+s);
    light.addColorStop(0,'rgba(255,255,255,.18)'); light.addColorStop(0.35,'rgba(255,255,255,.06)'); light.addColorStop(1,'rgba(255,255,255,0)');
    rr(c,x+1,y+1,s-2,s-2,Math.max(6,s*.22)); c.fillStyle=light; c.fill();
    rr(c,x+1,y+1,s-2,s-2,Math.max(6,s*.22)); c.lineWidth=Math.max(1,s*.06); c.strokeStyle='rgba(0,0,0,.40)'; c.stroke();
    rr(c,x+2,y+2,s-4,s-4,Math.max(5,s*.18)); c.lineWidth=Math.max(1,s*.04); c.strokeStyle='rgba(255,255,255,.10)'; c.stroke();
    if(placed){ rr(c,x+1,y+1,s-2,s-2,Math.max(6,s*.22));
      const gold=c.createLinearGradient(x,y,x,y+s); gold.addColorStop(0,'rgba(255,220,150,.70)'); gold.addColorStop(1,'rgba(175,120,40,.35)');
      c.lineWidth=Math.max(1,s*.07); c.strokeStyle=gold; c.stroke(); }
    c.restore();
  }
  function drawPlaced(c,x,y,s){ drawMatBlock(c,x,y,s,getCss('--accent')||'#FFD166',{alpha:.98,placed:true}); }
  function drawPreview(c,x,y,s,col,ok){ drawMatBlock(c,x,y,s, ok?col:'#c65454',{alpha: ok?.96:.88, placed:false}); }

  function drawPieceToCanvas(piece){
    const scale=24, pad=6, w=piece.w*scale+pad*2, h=piece.h*scale+pad*2;
    const c=document.createElement('canvas'); c.width=w*DPR; c.height=h*DPR; c.style.width=w+'px'; c.style.height=h+'px';
    const cx=c.getContext('2d'); cx.scale(DPR,DPR); cx.imageSmoothingEnabled=false;
    for(const [dx,dy] of piece.blocks) drawMatBlock(cx, pad+dx*scale, pad+dy*scale, scale-2, piece.color, {alpha:1});
    return c;
  }
  function renderTray(){
    trayEl.innerHTML='';
    state.hand.forEach((p,i)=>{
      const div=document.createElement('div');
      const fits=canFitAnywhere(p);
      div.className='slot'+(p.used?' used':'')+(p.used?'':(fits?' good':' bad'));
      div.dataset.index=String(i);
      div.appendChild(drawPieceToCanvas(p));
      if(!p.used) div.addEventListener('pointerdown', startDragFromSlot, {passive:false});
      trayEl.appendChild(div);
    });
  }

  function draw(){
    const s=state.cell, W=s*BOARD, H=s*BOARD;
    ctx.setTransform(1,0,0,1,0,0); ctx.clearRect(0,0,canvas.width,canvas.height); ctx.scale(DPR,DPR);
    drawAurora(ctx,W,H);
    rr(ctx,0,0,W,H,18);
    const panel=ctx.createLinearGradient(0,0,0,H);
    panel.addColorStop(0,'rgba(12,16,24,.18)'); panel.addColorStop(1,'rgba(12,16,24,.24)');
    ctx.fillStyle=panel; ctx.fill(); rr(ctx,1,1,W-2,H-2,16); ctx.strokeStyle='rgba(255,255,255,.10)'; ctx.lineWidth=1; ctx.stroke();
    for(let y=0;y<BOARD;y++){
      for(let x=0;x<BOARD;x++){
        const px=x*s, py=y*s, v=state.grid[y][x];
        rr(ctx,px+1,py+1,s-2,s-2,9);
        if(v===1){ drawPlaced(ctx,px,py,s); }
        else if(v===2){ rr(ctx,px+1,py+1,s-2,s-2,9); ctx.fillStyle=OBSTACLE_COLOR; ctx.fill(); }
        else{
          const fill=ctx.createLinearGradient(px,py,px,py+s);
          fill.addColorStop(0,'rgba(255,255,255,.06)'); fill.addColorStop(1,'rgba(0,0,0,.10)');
          ctx.fillStyle=fill; ctx.fill();
          rr(ctx,px+1.5,py+1.5,s-3,s-3,8); ctx.strokeStyle='var(--grid-border)'; ctx.lineWidth=1; ctx.stroke();
        }
      }
    }
    if(state.dragging && state.dragging.px!=null){
      const {piece, px, py, valid} = state.dragging;
      const liftY=72, offsetX=8, baseX=px-(piece.w*s)/2+offsetX, baseY=py-(piece.h*s)/2-liftY;
      for(const [dx,dy] of piece.blocks) drawPreview(ctx, baseX+dx*s, baseY+dy*s, s, piece.color, valid);
    }
  }

  // FX
  const particles=[]; function spawnParticles(cells){
    const s=state.cell,d=DPR; for(const [x,y] of cells){ for(let j=0;j<6;j++){ particles.push({x:(x+0.5)*s*d,y:(y+0.5)*s*d,vx:(Math.random()-0.5)*2,vy:(-Math.random()*2-0.5),life:40}); } }
  }
  function stepFX(){
    fctx.setTransform(1,0,0,1,0,0); fctx.clearRect(0,0,fxCnv.width,fxCnv.height); fctx.fillStyle='#ffffffaa';
    for(let i=0;i<particles.length;i++){ const p=particles[i]; p.x+=p.vx; p.y+=p.vy; p.vy+=0.05; p.life--; fctx.globalAlpha=Math.max(0,p.life/40); fctx.beginPath(); fctx.arc(p.x,p.y,2,0,Math.PI*2); fctx.fill(); }
    for(let i=particles.length-1;i>=0;i--) if(particles[i].life<=0) particles.splice(i,1);
    requestAnimationFrame(stepFX);
  } requestAnimationFrame(stepFX);

  // Scoring / placing
  function scoreForClear(c){ return c*10 + (c>1 ? (c-1)*5 : 0); }
  function place(piece,gx,gy){
    for(const [dx,dy] of piece.blocks) state.grid[gy+dy][gx+dx]=1;
    const fullRows=[], fullCols=[];
    for(let y=0;y<BOARD;y++){ let ok=true; for(let x=0;x<BOARD;x++){ if(state.grid[y][x]!==1){ ok=false; break; } } if(ok) fullRows.push(y); }
    for(let x=0;x<BOARD;x++){ let ok=true; for(let y=0;y<BOARD;y++){ if(state.grid[y][x]!==1){ ok=false; break; } } if(ok) fullCols.push(x); }
    const cleared=fullRows.length+fullCols.length;
    if(cleared>0){
      const cells=[]; for(const r of fullRows){ for(let x=0;x<BOARD;x++){ cells.push([x,r]); } state.grid[r]=Array(BOARD).fill(0); }
      for(const c of fullCols){ for(let y=0;y<BOARD;y++){ cells.push([c,y]); state.grid[y][c]=0; } }
      spawnParticles(cells); hapt(28);
    } else { hapt(12); }
    state.score += piece.blocks.length + scoreForClear(cleared); scoreEl.textContent=state.score;
    if(state.score>(state.best[state.mode]||0)){ state.best[state.mode]=state.score; saveBest(state.best); bestEl.textContent=state.score; }
    piece.used=true; state.hand=state.hand.map(p=>p.id===piece.id? {...p,used:true}:p); renderTray();
    if(state.hand.every(p=>p.used)) refillHand();
    if(state.mode!=='zen' && !anyFits()){ goStats.textContent=`Score: ${state.score} ‚Ä¢ Best: ${state.best[state.mode]||0}`; gameOver.style.display='flex'; hapt(40); }
    requestDraw();
  }
  function refillHand(){ state.hand=[newPiece(),newPiece(),newPiece()]; renderTray(); }

  // Dragging
  const POINTER={active:false,fromSlotIndex:null};
  function getCanvasPos(e){ const r=canvas.getBoundingClientRect(); return {x:(e.clientX-r.left), y:(e.clientY-r.top)}; }
  function startDragFromSlot(e){
    const idx=Number(e.currentTarget.dataset.index), piece=state.hand[idx]; if(!piece||piece.used) return;
    POINTER.active=true; POINTER.fromSlotIndex=idx; state.dragging={piece,gx:null,gy:null,valid:false,px:null,py:null};
    e.currentTarget.classList.add('used'); try{ e.currentTarget.setPointerCapture && e.currentTarget.setPointerCapture(e.pointerId); }catch(_){}
    document.body.style.cursor='grabbing'; e.preventDefault(); e.stopPropagation();
  }
  function onPointerMove(e){
    if(!POINTER.active||!state.dragging) return;
    const {x,y}=getCanvasPos(e); state.dragging.px=x; state.dragging.py=y;
    const s=state.cell, p=state.dragging.piece, liftY=72, offsetX=8;
    const baseX = x - (p.w*s)/2 + offsetX;
    const baseY = y - (p.h*s)/2 - liftY;
    let gx=Math.round(baseX/s), gy=Math.round(baseY/s);
    const maxX=BOARD-p.w, maxY=BOARD-p.h;
    if(gx<0||gx>maxX||gy<0||gy>maxY){ state.dragging.valid=false; state.dragging.gx=null; state.dragging.gy=null; }
    else { const ok=canPlace(p,gx,gy); state.dragging.valid=ok; state.dragging.gx=gx; state.dragging.gy=gy; }
    requestDraw();
  }
  function onPointerUp(){
    if(!POINTER.active||!state.dragging) return;
    const d=state.dragging; const slot=trayEl.querySelector('.slot[data-index="'+POINTER.fromSlotIndex+'"]');
    POINTER.active=false; document.body.style.cursor='';
    if(d.valid && d.gx!=null && d.gy!=null) place(d.piece,d.gx,d.gy);
    else if(slot) slot.classList.remove('used');
    state.dragging=null;
  }
  addEventListener('pointermove', onPointerMove, {passive:false});
  addEventListener('pointerup', onPointerUp, {passive:true});
  addEventListener('pointercancel', onPointerUp, {passive:true});

  // UI helpers
  function showToast(msg){
    let t=document.getElementById('toast');
    if(!t){ t=document.createElement('div'); t.id='toast'; document.body.appendChild(t);
      Object.assign(t.style,{position:'fixed',left:'50%',bottom:'24px',transform:'translateX(-50%)',background:'rgba(12,14,22,.82)',color:'#e8ecf1',padding:'10px 14px',borderRadius:'12px',boxShadow:'0 10px 30px rgba(0,0,0,.35)',zIndex:99,transition:'opacity .25s',opacity:'0',border:'1px solid rgba(255,255,255,.06)'}); }
    t.textContent=msg; t.style.opacity='1'; setTimeout(()=>{ t.style.opacity='0'; }, 1600);
  }
  function updateSoundLabel(){ setSound && (setSound.textContent = settings.sound?'üîà On':'üîá Off'); }
  function applyTheme(t){ document.body.classList.toggle('light', t==='light'); }
  function saveBest(b){ LS('bp8.best', JSON.stringify(b)); }
  function loadBest(){ const s=LS('bp8.best'); try{ return s? JSON.parse(s):null; }catch(e){ return null; } }

  // Events
  resetBtn.addEventListener('click', ()=> newGame(state.mode));
  backBtn.addEventListener('click', ()=> goHome());
  settingsBtn.addEventListener('click', ()=> settingsModal.style.display='flex');
  settingsModal.querySelector('.backdrop').addEventListener('click', ()=> settingsModal.style.display='none');
  closeSettings.addEventListener('click', ()=> settingsModal.style.display='none');
  setTheme.addEventListener('click', ()=>{ settings.theme=settings.theme==='dark'?'light':'dark'; LS('bp8.theme',settings.theme); applyTheme(settings.theme); });
  setSound.addEventListener('click', ()=>{ settings.sound=!settings.sound; LS('bp8.sound', settings.sound?'1':'0'); updateSoundLabel(); });
  resetBest.addEventListener('click', ()=>{ localStorage.removeItem('bp8.best'); state.best={classic:0,obstacles:0,zen:0}; bestEl.textContent=0; showToast('Best resetovan'); });

  achBtn.addEventListener('click', ()=> showToast('Dostignuƒáa ‚Äî uskoro'));
  playAgain.addEventListener('click', ()=>{ gameOver.style.display='none'; newGame(state.mode); });
  goMenu.addEventListener('click', ()=>{ gameOver.style.display='none'; goHome(); });
  startClassic.addEventListener('click', ()=> startGame('classic'));
  startObstacles.addEventListener('click', ()=> startGame('obstacles'));
  startZen.addEventListener('click', ()=> startGame('zen'));

  // Flow
  function startGame(mode){ state.mode=mode||'classic'; start.style.display='none'; app.style.display='flex'; sizeToScreen(); newGame(mode); }
  function goHome(){ app.style.display='none'; start.style.display='flex'; state.dragging=null; }
  function newGame(mode){
    state.grid=createGrid(BOARD);
    if(mode==='obstacles'){ const n=6+Math.floor(Math.random()*3); for(let i=0;i<n;i++){ const x=Math.floor(Math.random()*BOARD), y=Math.floor(Math.random()*BOARD); if(state.grid[y][x]===0) state.grid[y][x]=2; } }
    state.score=0; scoreEl.textContent=0; bestEl.textContent=String(state.best[mode]||0);
    state.hand=[]; refillHand(); requestDraw(); showToast(mode[0].toUpperCase()+mode.slice(1));
  }

  // Resize & BG loop
  function sizeToScreen(){
    const headerH=document.querySelector('header')?.offsetHeight||60;
    const trayH  =trayEl?.offsetHeight||120;
    const chrome =28;
    const availH=Math.max(260, innerHeight - headerH - trayH - chrome);
    const availW=Math.min(document.documentElement.clientWidth, 720) - 32;
    const side  =Math.max(240, Math.min(availW, availH));
    const cell  =Math.floor(side/BOARD);
    const px    =cell*BOARD;
    canvas.style.width=px+'px'; canvas.style.height=px+'px'; canvas.width=Math.floor(px*DPR); canvas.height=Math.floor(px*DPR);
    fxCnv.style.width=px+'px'; fxCnv.style.height=px+'px'; fxCnv.width=Math.floor(px*DPR); fxCnv.height=Math.floor(px*DPR);
    ctx.setTransform(1,0,0,1,0,0); ctx.scale(DPR,DPR); fctx.setTransform(1,0,0,1,0,0);
    state.cell=cell; bg.width=Math.floor(innerWidth*DPR); bg.height=Math.floor(innerHeight*DPR); requestDraw();
  }
  let drawQueued=false; function requestDraw(){ if(!drawQueued){ drawQueued=true; requestAnimationFrame(()=>{ drawQueued=false; draw(); }); } }
  function hapt(ms){ if(navigator.vibrate) navigator.vibrate(ms); }

  addEventListener('resize', sizeToScreen, {passive:true});
  sizeToScreen();
  (function loopBG(){ const b=bg.getContext('2d'); b.setTransform(1,0,0,1,0,0); b.scale(DPR,DPR); b.clearRect(0,0,bg.width,bg.height); drawAurora(b, innerWidth, innerHeight); requestAnimationFrame(loopBG); })();

  // Dev-fallback
  if(!startClassic){ start.style.display='none'; app.style.display='flex'; newGame('classic'); }
})();
</script>
</body>
</html>
